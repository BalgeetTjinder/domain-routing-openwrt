---

# Dnsmasq version check

  - name: Get dnsmasq version
    shell: opkg list-installed | grep dnsmasq-full | awk '{print $3}'
    register: dnsmasqfull_version

  - name: Check confdir option
    shell: uci get dhcp.@dnsmasq[0].confdir
    register: dnsmasq_confdir
    ignore_errors: true

  - name: Get openwrt major release
    shell: cat /etc/openwrt_release | grep -Eo [0-9]{2}[.][0-9]{2}[.][0-9]* | cut -d '.' -f 1 | tail -n 1
    register: openwrt_major_release

# Packages installation

  - name: install singbox
    opkg:
      name: "{{ item }}"
      state: present
    loop:
        - sing-box
    when: tunnel == "singbox" and (ansible_distribution_major_version | int) >= 23

  - name: install curl
    opkg:
      name: "{{ item }}"
      state: present
    loop:
        - curl

  - name: install nano
    opkg:
      name: "{{ item }}"
      state: present
    loop:
        - nano
    when: nano

  - name: install dnsmasq-full (23+)
    shell: opkg update && cd /tmp/ && opkg download dnsmasq-full && opkg remove dnsmasq && opkg install dnsmasq-full --cache /tmp/ && [ -f /etc/config/dhcp-opkg ] && cp /etc/config/dhcp /etc/config/dhcp-old && mv /etc/config/dhcp-opkg /etc/config/dhcp
    when: (ansible_distribution_major_version | int) >= 23 and list_domains and not dnsmasqfull_version.stdout

  - name: set confdir for dnsmasq
    uci: 
      command: set
      key: dhcp.@dnsmasq[0]
      value:
        confdir: "/tmp/dnsmasq.d"
    when: (ansible_distribution_major_version | int) >= 24
    notify:
      - Restart dnsmasq  

# Getdomains script configure
      
  - name: getdomains script copy
    template:
      src: "openwrt-getdomains.j2"
      dest: "/etc/init.d/getdomains"
      mode: a+x
      trim_blocks: false
    notify:
      - Run getdomains script

  - name: create simplink in rc.d
    file:
      src: "/etc/init.d/getdomains"
      dest: "/etc/rc.d/S99getdomains"
      state: link
    notify:
      - Run getdomains script

  - name: check string in crontab
    shell: grep "getdomains" /etc/crontabs/root
    register: check_cron
    ignore_errors: true
     
  - name: add script to cron
    lineinfile:
      path: /etc/crontabs/root
      create: yes
      line: "0 4 * * * /etc/init.d/getdomains start"
    when: check_cron.stdout == ""
    
  - name: enable and start crontab
    service:
      name: cron
      state: started
      enabled: yes
      
# Configure route table

  - name: Route for vpn table
    template:
      src: "openwrt-30-vpnroute.j2"
      dest: "/etc/hotplug.d/iface/30-vpnroute"
      mode: 0644

  - name: Check string in rt_tables
    shell: grep "99 vpn" /etc/iproute2/rt_tables
    register: check_rt_tables
    ignore_errors: true
      
  - name: add route table
    lineinfile:
      path: /etc/iproute2/rt_tables
      line: "99 vpn"
    when: check_rt_tables.stdout == ""
    notify:
      - Restart network

# Configure Sing-box

  - name: set sing-box firewall zone
    uci:
      command: section
      config: firewall
      type: zone
      find_by:
        name: tun
      value:
        forward: ACCEPT
        output: ACCEPT
        name: tun
        input: ACCEPT
        masq: 1
        mtu_fix: 1
        device: tun0
        family: ipv4
    when: tunnel == "singbox"
    failed_when: (ansible_distribution_major_version | int) < 23
    notify:
      - Restart firewall

  - name: template for sing-box.json (VLESS + Reality)
    template:
      src: "sing-box-vless-reality.j2"
      dest: "/etc/sing-box/config.json"
      mode: 0644
    when: tunnel == "singbox" and singbox_protocol == "vless-reality"
    failed_when: (ansible_distribution_major_version | int) < 23
    notify:
      - Restart sing-box

  - name: template for sing-box.json (Hysteria 2)
    template:
      src: "sing-box-hysteria2.j2"
      dest: "/etc/sing-box/config.json"
      mode: 0644
    when: tunnel == "singbox" and singbox_protocol == "hysteria2"
    failed_when: (ansible_distribution_major_version | int) < 23
    notify:
      - Restart sing-box

  - name: template for sing-box.json (Multi - VLESS + Hysteria2)
    template:
      src: "sing-box-multi.j2"
      dest: "/etc/sing-box/config.json"
      mode: 0644
    when: tunnel == "singbox" and singbox_protocol == "multi"
    failed_when: (ansible_distribution_major_version | int) < 23
    notify:
      - Restart sing-box

  - name: add sing-box forwarding
    uci:
      command: section
      config: firewall
      type: forwarding
      find_by:
        name: lan-tun
      value:
        dest: tun
        src: lan
        family: ipv4
    when: tunnel == "singbox"
    notify:
      - Restart firewall

# Configure network
       
  - name: set rule mark0x1
    uci:
      command: section
      config: network
      type: rule
      find_by:
        name: mark0x1
      value:
        mark: "0x1"
        priority: 100
        lookup: vpn

  - name: uci commit firewall
    uci:
      command: commit
      config: firewall
    notify:
      - Restart firewall

  - name: uci commit network
    uci:
      command: commit
      config: network
    notify:
      - Restart network

# Configure firewall - domain sets

  - name: add nfset for domains (>=23)
    uci:
       command: section
       config: firewall
       type: ipset
       find_by:
         name: vpn_domains
       value:
         match: dst_net
    when: (ansible_distribution_major_version | int) >= 23 and list_domains

  - name: add mark rule vpn_domains
    uci:
       command: section
       config: firewall
       type: rule
       find_by:
         name: mark_domains
       value:
         src: lan
         dest: "*"
         proto: all
         ipset: vpn_domains
         set_mark: "0x1"
         target: MARK
         family: ipv4
    when: list_domains

# Configure DNS resolver

  - name: install dnscrypt-proxy2
    opkg:
      name: dnscrypt-proxy2
      state: present
    when: dns_encrypt == "dnscrypt"

  - name: check string in dnscrypt-proxy.toml
    shell: grep "# server_names" /etc/dnscrypt-proxy2/dnscrypt-proxy.toml
    register: check_server_names
    ignore_errors: true
    when: dns_encrypt == "dnscrypt"

  - name: dnscrypt2 enable exact servers
    lineinfile:
      path: /etc/dnscrypt-proxy2/dnscrypt-proxy.toml
      regexp: "# server_names ="
      line: "server_names = ['google', 'cloudflare', 'scaleway-fr', 'yandex']"
    when: dns_encrypt == "dnscrypt" and check_server_names.stdout
    notify:
      - Restart dnscrypt-proxy
    
  - name: edit dhcp config for dnscrypt
    lineinfile:
      path: /etc/config/dhcp
      firstmatch: "true"
      insertafter: "option leasefile '/tmp/dhcp.leases'"
      line: "{{ item }}"
    with_items:
      - "        list server '127.0.0.53#53'"
      - "        option noresolv '1'"
    notify:
      - Restart dnsmasq
    when: dns_encrypt == "dnscrypt"

  - name: install stubby
    opkg:
      name: stubby
      state: present
    when: dns_encrypt == "stubby"

  - name: edit dhcp config for stubby
    lineinfile:
      path: /etc/config/dhcp
      firstmatch: "true"
      insertafter: "option leasefile '/tmp/dhcp.leases'"
      line: "{{ item }}"
    with_items:
      - "        list server '127.0.0.1#5453'"
      - "        option noresolv '1'"
    notify:
      - Restart dnsmasq
    when: dns_encrypt == "stubby"

# Commit

  - name: uci commit firewall
    uci:
      command: commit
      config: firewall
    notify:
      - Restart firewall

  - name: uci commit dhcp
    uci:
      command: commit
      config: dhcp
    notify:
      - Restart dnsmasq

  - name: uci commit network
    uci:
      command: commit
      config: network
    notify:
      - Restart network
