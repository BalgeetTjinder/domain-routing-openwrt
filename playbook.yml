# Playbook для настройки GL.iNet Flint 2 (GL-MT6000)
# Точечная маршрутизация через Sing-box (VLESS Reality + Hysteria 2)
#
# Использование:
#   1. Установи зависимость: ansible-galaxy role install gekmihesg.openwrt
#   2. Заполни данные ниже (из S-UI панели)
#   3. Запусти: ansible-playbook -i inventory.ini playbook.yml

- hosts: router
  remote_user: root
  gather_facts: yes

  vars:
    # === Основные настройки ===
    tunnel: singbox
    singbox_protocol: multi          # multi = оба протокола с переключением
    dns_encrypt: stubby              # Шифрование DNS (stubby/dnscrypt/false)
    country: russia-inside           # Список доменов для обхода
    list_domains: true
    nano: true

    # === VLESS + Reality ===
    vless_enabled: true
    vless_server: "79.137.195.239"
    vless_port: 443
    vless_uuid: "d8acbbe7-b7fd-485c-c04a-4b6b4c480112"
    vless_sni: "www.microsoft.com"
    vless_fingerprint: "chrome"
    vless_public_key: "UxbZ9OP76wbENt5g1PBx_QcHi-RnNW_8HH54GtjmZXU"
    vless_short_id: "92a9b477"

    # === Hysteria 2 ===
    hysteria2_enabled: true
    hysteria2_server: "79.137.195.239"
    hysteria2_port: 8443
    hysteria2_password: "x0nHAG5ol7"
    hysteria2_sni: "dev.milostyle.online"
    hysteria2_up_mbps: 100
    hysteria2_down_mbps: 100

  roles:
    - gekmihesg.openwrt

  tasks:
    - include_tasks: tasks/main.yml

  handlers:
    - name: Restart sing-box
      service:
        name: sing-box
        state: restarted

    - name: Restart network
      service:
        name: network
        state: restarted

    - name: Restart firewall
      service:
        name: firewall
        state: restarted

    - name: Run getdomains script
      shell: /etc/init.d/getdomains start

    - name: Restart dnscrypt-proxy
      service:
        name: dnscrypt-proxy
        state: restarted
        enabled: yes

    - name: Restart stubby
      service:
        name: stubby
        state: restarted
        enabled: yes

    - name: Restart dnsmasq
      service:
        name: dnsmasq
        state: restarted
